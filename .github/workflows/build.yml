name: Build OpenClaw VM (Optimized)

on:
  schedule:
    - cron: '0 2 * * *'  # 每天檢查
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-openclaw-update:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      image_digest: ${{ steps.check.outputs.digest }}
    steps:
      - name: Get latest OpenClaw Docker image
        id: check
        run: |
          # Check if official OpenClaw image has been updated
          LATEST_DIGEST=$(docker manifest inspect ghcr.io/openclaw/openclaw:main | jq -r .config.digest)
          echo "digest=$LATEST_DIGEST" >> $GITHUB_OUTPUT

          # Check if we already built this version
          if gh release view "vm-${LATEST_DIGEST:7:12}" &>/dev/null; then
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

  build-vm:
    needs: check-openclaw-update
    if: needs.check-openclaw-update.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        variant: [headless]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install QEMU tools
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-utils

      - name: Pull official OpenClaw image
        run: |
          docker pull ghcr.io/openclaw/openclaw:main
          docker tag ghcr.io/openclaw/openclaw:main openclaw:latest

      - name: Customize for ${{ matrix.variant }}
        run: |
          docker build \
            -f dockerfiles/Dockerfile.${{ matrix.variant }} \
            -t openclaw-${{ matrix.variant }}:latest \
            .

      - name: Export Docker image to rootfs
        run: |
          CONTAINER_ID=$(docker create openclaw-${{ matrix.variant }}:latest)
          docker export $CONTAINER_ID -o rootfs.tar
          docker rm $CONTAINER_ID
          
          echo "Rootfs size: $(du -h rootfs.tar | cut -f1)"

      - name: Create QEMU VM disk
        run: qemu-img create -f qcow2 openclaw-${{ matrix.variant }}.qcow2 8G

      - name: Install system to VM disk
        run: |
          sudo modprobe nbd max_part=8
          sudo qemu-nbd --connect=/dev/nbd0 openclaw-${{ matrix.variant }}.qcow2
          sleep 2
          
          # 分區和格式化
          sudo parted /dev/nbd0 --script mklabel msdos
          sudo parted /dev/nbd0 --script mkpart primary ext4 1MiB 100%
          sudo partprobe /dev/nbd0
          sleep 2
          sudo mkfs.ext4 -F /dev/nbd0p1
          
          # 掛載並解壓
          sudo mkdir -p /mnt/vm
          sudo mount /dev/nbd0p1 /mnt/vm
          sudo tar -xf rootfs.tar -C /mnt/vm
          
          # 配置 fstab
          echo '/dev/sda1 / ext4 defaults 0 1' | sudo tee /mnt/vm/etc/fstab
          
          # 安裝 bootloader
          sudo mount --bind /dev /mnt/vm/dev
          sudo mount --bind /proc /mnt/vm/proc
          sudo mount --bind /sys /mnt/vm/sys
          
          sudo chroot /mnt/vm /bin/bash -c "
            grub-install --target=i386-pc /dev/nbd0
            update-grub
          "
          
          # 清理
          sudo umount /mnt/vm/dev /mnt/vm/proc /mnt/vm/sys
          sudo umount /mnt/vm
          sudo qemu-nbd --disconnect /dev/nbd0

      - name: Compress and checksum
        run: |
          qemu-img convert -c -O qcow2 \
            openclaw-${{ matrix.variant }}.qcow2 \
            openclaw-${{ matrix.variant }}-compressed.qcow2
          
          sha256sum openclaw-${{ matrix.variant }}-compressed.qcow2 > \
            openclaw-${{ matrix.variant }}.sha256
          
          echo "Final size:"
          ls -lh openclaw-${{ matrix.variant }}-compressed.qcow2

          echo "Splitting into parts..."
          mkdir -p dist
          if (( $(stat -c %s "openclaw-${{ matrix.variant }}-compressed.qcow2") > 1900000000 )); then
            tar czf - openclaw-${{ matrix.variant }}-compressed.qcow2 | \
              split -b 1900m - dist/openclaw-${{ matrix.variant }}.tar.gz.

            echo "✓ Split completed:"
            ls -lh dist/openclaw-${{ matrix.variant }}.tar.gz.* | awk '{print "  " $9 " (" $5 ")"}'
          else
            echo "File is 1.9 GB or smaller"
            mv openclaw-${{ matrix.variant }}-compressed.qcow2 dist/
            mv openclaw-${{ matrix.variant }}.sha256 dist/
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: openclaw-vm-${{ matrix.variant }}
          path: dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*
          tag_name: vm-${{ matrix.variant }}-${{ github.run_id }}
          body: |
            # OpenClaw VM - ${{ matrix.variant }} Edition
            
            **Built from:** `alpine/openclaw:latest`
            **Date:** ${{ github.event.repository.updated_at }}
            
            ## Files

            If file smaller than 1.9GB:
            - `openclaw-${{ matrix.variant }}-compressed.qcow2` - Image files
            - `openclaw-${{ matrix.variant }}.sha256` - SHA256 checksums

            If file larger than 1.9GB:
            - `openclaw-${{ matrix.variant }}.tar.gz.*` - Split image files
            - `openclaw-${{ matrix.variant }}.sha256` - SHA256 checksums
            
            ## Quick Start
            
            1. Download all split files
            2. Extract file: `cat *.tar.gz.* | tar xvfz -`
            3. Start: `qemu-system-x86_64 -drive file=openclaw-${{ matrix.variant }}-compressed.qcow2,format=qcow2`
            4. Onboard: `cd /app && node openclaw.mjs onboard`
            
            ## Verify
            
            ```bash
            sha256sum -c openclaw-${{ matrix.variant }}.sha256
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update README with VM download link
        run: |
          TAG="vm-${{ matrix.variant }}-${{ github.run_id }}"
          REPO="NewJerseyStyle/QemuClaw"

          # Build the download URL based on whether files were split
          if ls dist/openclaw-${{ matrix.variant }}.tar.gz.* 1>/dev/null 2>&1; then
            # Split files - link to the release page
            URL="https://github.com/${REPO}/releases/tag/${TAG}"
            LINK_TEXT="Download OpenClaw VM Image (${TAG}) — multiple split files, see release page"
          else
            # Single qcow2 file - direct download link
            FILE="openclaw-${{ matrix.variant }}-compressed.qcow2"
            URL="https://github.com/${REPO}/releases/download/${TAG}/${FILE}"
            LINK_TEXT="Download OpenClaw VM Image (${TAG})"
          fi

          # Replace content between VM_DOWNLOAD markers
          sed -i "/<!-- VM_DOWNLOAD:START -->/,/<!-- VM_DOWNLOAD:END -->/{
            /<!-- VM_DOWNLOAD:START -->/!{/<!-- VM_DOWNLOAD:END -->/!d}
            /<!-- VM_DOWNLOAD:START -->/a\\
          [${LINK_TEXT}](${URL})
          }" README.md

          echo "Updated README VM download link: $URL"

      - name: Commit and push README
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "ci: update VM image download link for ${{ matrix.variant }}-${{ github.run_id }}"
          git push

      - name: Cleanup
        if: always()
        run: |
          rm -f rootfs.tar openclaw-*.qcow2 Dockerfile.custom
          docker system prune -af

  notify:
    name: Build Summary
    needs: [build-vm]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Check status
        run: |
          if [ "${{ needs.build-vm.result }}" = "success" ]; then
            echo "✓ All VM builds completed successfully!"
            exit 0
          else
            echo "✗ Some builds failed"
            exit 1
          fi
