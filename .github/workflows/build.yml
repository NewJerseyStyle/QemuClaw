name: Build and Split OpenClaw VM

on:
  schedule:
    # 每天 UTC 2 点检查
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/build-vm.yml'
      - 'scripts/**'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: openclaw-docker
  PART_SIZE: 1500m

jobs:
  check-openclaw:
    name: Check for OpenClaw Updates
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      image_digest: ${{ steps.check.outputs.digest }}
      timestamp: ${{ steps.check.outputs.timestamp }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Check for OpenClaw updates
        id: check
        run: bash scripts/check-openclaw-update.sh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-vm:
    name: Build OpenClaw VM (${{ matrix.variant }})
    needs: check-openclaw
    if: needs.check-openclaw.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        variant: [gui, headless]
      max-parallel: 1
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up environment
        run: bash scripts/setup-environment.sh

      - name: Free up disk space
        run: |
          sudo apt-get remove -y ghc-* google-cloud-cli azure-cli || true
          sudo apt-get autoremove -y
          sudo rm -rf /usr/share/dotnet /usr/share/swift
          echo "Available disk space:"
          df -h /

      - name: Pull OpenClaw Docker image
        run: |
          echo "Pulling official OpenClaw image..."
          docker pull ghcr.io/phioranex/openclaw-docker:latest
          docker tag ghcr.io/phioranex/openclaw-docker:latest openclaw:latest
          docker images | grep openclaw

      - name: Generate Dockerfile for ${{ matrix.variant }}
        run: bash scripts/generate-dockerfile.sh ${{ matrix.variant }}

      - name: Build custom Docker image
        run: |
          echo "Building Docker image for ${{ matrix.variant }}..."
          docker build -f Dockerfile.custom -t openclaw-${{ matrix.variant }}:latest .
          docker images | grep openclaw

      - name: Create VM disk
        run: |
          DISK_SIZE=${{ matrix.variant == 'gui' && '12G' || '8G' }}
          echo "Creating $DISK_SIZE disk..."
          qemu-img create -f qcow2 openclaw-${{ matrix.variant }}.qcow2 $DISK_SIZE

      - name: Install system to VM disk
        run: bash scripts/install-system-to-vm.sh ${{ matrix.variant }}

      - name: Compress and split disk
        run: |
          mkdir -p dist
          bash scripts/compress-and-split.sh ${{ matrix.variant }} dist ${{ env.PART_SIZE }}

      - name: Generate recovery files
        run: bash scripts/generate-recovery-files.sh ${{ matrix.variant }} dist

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openclaw-vm-${{ matrix.variant }}
          path: dist/
          retention-days: 30

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*
          tag_name: vm-${{ matrix.variant }}-${{ needs.check-openclaw.outputs.timestamp }}
          body: |
            # OpenClaw VM - ${{ matrix.variant }} Edition
            
            **Built**: ${{ needs.check-openclaw.outputs.timestamp }}
            **Image Digest**: `${{ needs.check-openclaw.outputs.image_digest }}`
            
            ## Files
            
            - `openclaw-${{ matrix.variant }}.tar.gz.aa` (and more parts)
            - `openclaw-${{ matrix.variant }}.sha256` - Checksums
            - `openclaw-${{ matrix.variant }}-recover.sh` - Recovery script
            - `README-${{ matrix.variant }}.md` - Instructions
            
            ## Quick Start
            
            ```bash
            bash openclaw-${{ matrix.variant }}-recover.sh
            ```
            
            ## Verify
            
            ```bash
            sha256sum -c openclaw-${{ matrix.variant }}.sha256
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup
        if: always()
        run: bash scripts/cleanup.sh ${{ matrix.variant }}

  notify:
    name: Build Complete
    needs: [build-vm]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Check status
        run: |
          if [ "${{ needs.build-vm.result }}" = "success" ]; then
            echo "✓ All builds completed successfully"
            exit 0
          else
            echo "✗ Some builds failed"
            exit 1
          fi
