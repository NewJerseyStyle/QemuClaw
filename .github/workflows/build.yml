name: Build and Split OpenClaw VM

on:
  schedule:
    # 每天 UTC 2 点检查并构建
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/build-vm.yml'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: openclaw-docker
  PART_SIZE: 1500m

jobs:
  check-openclaw:
    name: Check OpenClaw Updates
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      image_digest: ${{ steps.check.outputs.digest }}
      timestamp: ${{ steps.check.outputs.timestamp }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for OpenClaw updates
        id: check
        run: |
          set -e
          
          echo "Checking OpenClaw Docker image..."
          
          # 获取最新的镜像摘要
          LATEST_DIGEST=$(docker manifest inspect ghcr.io/phioranex/openclaw-docker:latest 2>/dev/null | \
            jq -r '.config.digest' || echo "unknown")
          
          echo "Latest digest: $LATEST_DIGEST"
          echo "digest=$LATEST_DIGEST" >> $GITHUB_OUTPUT
          
          # 检查是否已经为这个版本构建过
          RELEASE_TAG="vm-${LATEST_DIGEST:7:12}"
          
          if gh release view "$RELEASE_TAG" &>/dev/null 2>&1; then
            echo "Already built for this version"
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "New version detected"
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi
          
          # 记录时间戳
          echo "timestamp=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-vm:
    name: Build OpenClaw VM (${{ matrix.variant }})
    needs: check-openclaw
    if: needs.check-openclaw.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        variant: [gui, headless]
      max-parallel: 1  # 依次构建以节省资源
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Install QEMU and utilities
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-utils \
            qemu-system-x86-64 \
            e2fsprogs \
            parted \
            grub-pc-bin \
            p7zip-full \
            pv

      - name: Free up disk space
        run: |
          # 删除不需要的软件以节省空间
          sudo apt-get remove -y ghc-* google-cloud-cli azure-cli || true
          sudo apt-get autoremove -y
          sudo rm -rf /usr/share/dotnet /usr/share/swift
          
          echo "Available disk space:"
          df -h /

      - name: Pull OpenClaw Docker image
        run: |
          echo "Pulling official OpenClaw image..."
          docker pull ghcr.io/phioranex/openclaw-docker:latest
          docker tag ghcr.io/phioranex/openclaw-docker:latest openclaw:latest
          
          docker images | grep openclaw

      - name: Create custom Dockerfile for ${{ matrix.variant }}
        run: |
          if [ "${{ matrix.variant }}" = "gui" ]; then
            cat > Dockerfile.custom << 'EOF'
FROM openclaw:latest

USER root

# 安装 GUI 环境
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
      systemd systemd-sysv systemd-container \
      linux-image-amd64 \
      grub-pc grub-common \
      grub-efi-amd64 \
      xorg x11-apps \
      xfce4 xfce4-terminal \
      lightdm lightdm-gtk-greeter \
      dbus-x11 \
      firefox-esr \
      fonts-noto-cjk \
      fonts-noto-cjk-extra && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/*

# 配置 lightdm
RUN systemctl enable lightdm 2>/dev/null || true

# 创建启动脚本
RUN mkdir -p /usr/local/bin && \
    echo '#!/bin/bash' > /usr/local/bin/start-openclaw && \
    echo 'cd /app && node dist/index.js gateway --bind lan' >> /usr/local/bin/start-openclaw && \
    chmod +x /usr/local/bin/start-openclaw

USER node
CMD ["/sbin/init"]
EOF
          else
            # Headless 版本
            cat > Dockerfile.custom << 'EOF'
FROM openclaw:latest

USER root

# 安装最小化系统包
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
      systemd systemd-sysv \
      linux-image-amd64 \
      grub-pc grub-common \
      grub-efi-amd64 \
      nginx \
      curl \
      wget && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/*

# 配置 Nginx
RUN rm -f /etc/nginx/sites-enabled/default && \
    echo 'server {' > /etc/nginx/sites-available/openclaw && \
    echo '  listen 3000 default_server;' >> /etc/nginx/sites-available/openclaw && \
    echo '  listen [::]:3000 default_server;' >> /etc/nginx/sites-available/openclaw && \
    echo '  server_name _;' >> /etc/nginx/sites-available/openclaw && \
    echo '  location / {' >> /etc/nginx/sites-available/openclaw && \
    echo '    proxy_pass http://localhost:18789;' >> /etc/nginx/sites-available/openclaw && \
    echo '    proxy_http_version 1.1;' >> /etc/nginx/sites-available/openclaw && \
    echo '    proxy_set_header Upgrade $http_upgrade;' >> /etc/nginx/sites-available/openclaw && \
    echo '    proxy_set_header Connection "upgrade";' >> /etc/nginx/sites-available/openclaw && \
    echo '    proxy_set_header Host $host;' >> /etc/nginx/sites-available/openclaw && \
    echo '  }' >> /etc/nginx/sites-available/openclaw && \
    echo '}' >> /etc/nginx/sites-available/openclaw && \
    ln -s /etc/nginx/sites-available/openclaw /etc/nginx/sites-enabled/openclaw

# 配置 systemd 服务
RUN echo '[Unit]' > /etc/systemd/system/openclaw.service && \
    echo 'Description=OpenClaw Gateway' >> /etc/systemd/system/openclaw.service && \
    echo 'After=network.target' >> /etc/systemd/system/openclaw.service && \
    echo '' >> /etc/systemd/system/openclaw.service && \
    echo '[Service]' >> /etc/systemd/system/openclaw.service && \
    echo 'Type=simple' >> /etc/systemd/system/openclaw.service && \
    echo 'User=node' >> /etc/systemd/system/openclaw.service && \
    echo 'WorkingDirectory=/app' >> /etc/systemd/system/openclaw.service && \
    echo 'ExecStart=/usr/bin/node dist/index.js gateway --bind lan' >> /etc/systemd/system/openclaw.service && \
    echo 'Restart=always' >> /etc/systemd/system/openclaw.service && \
    echo 'RestartSec=10' >> /etc/systemd/system/openclaw.service && \
    echo '' >> /etc/systemd/system/openclaw.service && \
    echo '[Install]' >> /etc/systemd/system/openclaw.service && \
    echo 'WantedBy=multi-user.target' >> /etc/systemd/system/openclaw.service && \
    systemctl enable openclaw.service 2>/dev/null || true && \
    systemctl enable nginx.service 2>/dev/null || true

USER node
CMD ["/sbin/init"]
EOF
          fi

      - name: Build custom Docker image
        run: |
          echo "Building custom image for ${{ matrix.variant }}..."
          docker build -f Dockerfile.custom -t openclaw-${{ matrix.variant }}:latest .
          
          docker images | grep openclaw

      - name: Export Docker image to rootfs
        run: |
          echo "Exporting Docker image..."
          
          CONTAINER_ID=$(docker create openclaw-${{ matrix.variant }}:latest)
          echo "Container ID: $CONTAINER_ID"
          
          docker export $CONTAINER_ID > rootfs.tar
          docker rm $CONTAINER_ID
          
          echo "Rootfs exported:"
          du -h rootfs.tar

      - name: Create QEMU VM disk
        run: |
          DISK_SIZE=${{ matrix.variant == 'gui' && '12G' || '8G' }}
          echo "Creating $DISK_SIZE disk for ${{ matrix.variant }}..."
          
          qemu-img create -f qcow2 openclaw-${{ matrix.variant }}.qcow2 $DISK_SIZE

      - name: Install system to VM disk
        run: |
          set -e
          
          echo "Installing system to VM disk..."
          
          # 加载 NBD 模块
          sudo modprobe nbd max_part=8
          
          # 连接 qcow2 到 NBD
          sudo qemu-nbd --connect=/dev/nbd0 openclaw-${{ matrix.variant }}.qcow2
          sleep 2
          
          # 分区和格式化
          echo "Partitioning disk..."
          sudo parted /dev/nbd0 --script mklabel msdos
          sudo parted /dev/nbd0 --script mkpart primary ext4 1MiB 100%
          sudo partprobe /dev/nbd0
          sleep 2
          
          echo "Formatting partition..."
          sudo mkfs.ext4 -F /dev/nbd0p1
          
          # 掛載並解壓
          echo "Mounting and extracting rootfs..."
          sudo mkdir -p /mnt/vm
          sudo mount /dev/nbd0p1 /mnt/vm
          sudo tar -xf rootfs.tar -C /mnt/vm
          
          # 配置 fstab
          echo "Configuring fstab..."
          echo '/dev/sda1 / ext4 defaults,errors=remount-ro 0 1' | sudo tee /mnt/vm/etc/fstab
          
          # 安装 bootloader
          echo "Installing bootloader..."
          sudo mount --bind /dev /mnt/vm/dev
          sudo mount --bind /proc /mnt/vm/proc
          sudo mount --bind /sys /mnt/vm/sys
          sudo mount --bind /boot /mnt/vm/boot || true
          
          sudo chroot /mnt/vm /bin/bash -c "
            set -e
            export DEBIAN_FRONTEND=noninteractive
            
            # 安装 grub
            apt-get update
            apt-get install -y --no-install-recommends grub-pc grub-efi-amd64
            
            # 配置 grub
            grub-install --target=i386-pc /dev/nbd0
            update-grub
          " || echo "Bootloader installation completed with warnings"
          
          # 清理
          echo "Cleaning up..."
          sudo umount /mnt/vm/boot 2>/dev/null || true
          sudo umount /mnt/vm/dev /mnt/vm/proc /mnt/vm/sys
          sudo umount /mnt/vm
          sudo qemu-nbd --disconnect /dev/nbd0
          
          echo "VM installation completed"

      - name: Compress VM disk with QEMU
        run: |
          echo "Compressing VM disk..."
          
          qemu-img convert -c -O qcow2 \
            openclaw-${{ matrix.variant }}.qcow2 \
            openclaw-${{ matrix.variant }}-compressed.qcow2
          
          echo "Compression completed:"
          du -h openclaw-${{ matrix.variant }}-compressed.qcow2

      - name: Split and compress archive
        run: |
          set -e
          
          echo "Splitting image into parts of ${{ env.PART_SIZE }}..."
          
          VARIANT=${{ matrix.variant }}
          FILE="openclaw-${VARIANT}-compressed.qcow2"
          
          mkdir -p dist
          
          # 使用 tar + gzip + split
          tar czf - "$FILE" | split -b ${{ env.PART_SIZE }} - "dist/openclaw-${VARIANT}.tar.gz."
          
          echo "Split completed:"
          ls -lh dist/openclaw-${VARIANT}.tar.gz.*
          
          # 计算总大小和压缩率
          TOTAL_SIZE=$(du -sb dist/ | awk '{print $1}')
          ORIGINAL_SIZE=$(stat -c%s "$FILE")
          RATIO=$(echo "scale=2; $ORIGINAL_SIZE / $TOTAL_SIZE" | bc -l)
          
          echo ""
          echo "Statistics:"
          echo "  Original size: $(numfmt --to=iec-i --suffix=B $ORIGINAL_SIZE 2>/dev/null || du -h "$FILE" | cut -f1)"
          echo "  Split total:   $(numfmt --to=iec-i --suffix=B $TOTAL_SIZE 2>/dev/null || du -sh dist/ | cut -f1)"
          echo "  Compression:   ${RATIO}x"

      - name: Generate checksums and manifests
        run: |
          set -e
          
          VARIANT=${{ matrix.variant }}
          cd dist
          
          # 生成 SHA256 校验和
          echo "Generating SHA256 checksums..."
          sha256sum openclaw-${VARIANT}.tar.gz.* > openclaw-${VARIANT}.sha256
          
          # 生成清单文件
          echo "Generating manifest..."
          cat > openclaw-${VARIANT}.manifest << EOF
# OpenClaw VM - ${VARIANT^^} Edition 镜像清单
# 生成时间: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
# 
EOF
          
          ls -lh openclaw-${VARIANT}.tar.gz.* >> openclaw-${VARIANT}.manifest
          
          # 显示校验和
          echo ""
          echo "Checksums:"
          head -n 2 openclaw-${VARIANT}.sha256

      - name: Generate recovery script
        run: |
          VARIANT=${{ matrix.variant }}
          
          cat > dist/openclaw-${VARIANT}-recover.sh << 'RECOVERY_EOF'
#!/bin/bash
set -e

VARIANT=${{ matrix.variant }}
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$SCRIPT_DIR"

echo "=========================================="
echo "OpenClaw VM Recovery Tool"
echo "=========================================="
echo "Variant: $VARIANT"
echo ""

# 检查文件
PART_COUNT=$(ls -1 openclaw-${VARIANT}.tar.gz.* 2>/dev/null | wc -l)
if [ $PART_COUNT -eq 0 ]; then
  echo "Error: No split files found"
  exit 1
fi

echo "Found $PART_COUNT split files"
echo ""

# 验证
if [ -f openclaw-${VARIANT}.sha256 ]; then
  echo "Verifying checksums..."
  if ! sha256sum -c openclaw-${VARIANT}.sha256; then
    echo "Error: Verification failed!"
    exit 1
  fi
  echo "✓ All files verified"
else
  echo "Warning: Checksum file not found, skipping verification"
fi

echo ""
echo "Extracting files (this may take a while)..."

# 合并和解压
if command -v pv &> /dev/null; then
  cat openclaw-${VARIANT}.tar.gz.* | \
    pv -N "Extracting" | \
    tar xzf -
else
  cat openclaw-${VARIANT}.tar.gz.* | tar xzf -
fi

echo ""
if [ -f openclaw-${VARIANT}-compressed.qcow2 ]; then
  echo "✓ Recovery completed successfully!"
  echo ""
  ls -lh openclaw-${VARIANT}-compressed.qcow2
  echo ""
  echo "Next steps:"
  echo "  qemu-system-x86_64 -drive file=openclaw-${VARIANT}-compressed.qcow2,format=qcow2 -m 4G"
else
  echo "Error: Output file not found"
  exit 1
fi
RECOVERY_EOF
          
          chmod +x dist/openclaw-${VARIANT}-recover.sh
          
          echo "Recovery script generated"

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/openclaw-${{ matrix.variant }}.tar.gz.*
            dist/openclaw-${{ matrix.variant }}.sha256
            dist/openclaw-${{ matrix.variant }}.manifest
            dist/openclaw-${{ matrix.variant }}-recover.sh
          tag_name: vm-${{ matrix.variant }}-${{ needs.check-openclaw.outputs.timestamp }}
          body: |
            # OpenClaw VM - ${{ matrix.variant }} Edition
            
            Built: ${{ needs.check-openclaw.outputs.timestamp }}
            OpenClaw Image Digest: `${{ needs.check-openclaw.outputs.image_digest }}`
            
            ## Files
            
            This release contains split and compressed VM images:
            - `openclaw-${{ matrix.variant }}.tar.gz.aa` (and more parts)
            - `openclaw-${{ matrix.variant }}.sha256` - Checksums
            - `openclaw-${{ matrix.variant }}-recover.sh` - Recovery script
            
            ## Quick Start
            
            ```bash
            bash openclaw-${{ matrix.variant }}-recover.sh
            ```
            
            ## Verify
            
            ```bash
            sha256sum -c openclaw-${{ matrix.variant }}.sha256
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup
        if: always()
        run: |
          echo "Cleaning up temporary files..."
          rm -f rootfs.tar
          rm -f openclaw-${{ matrix.variant }}.qcow2
          rm -f openclaw-${{ matrix.variant }}-compressed.qcow2
          rm -f Dockerfile.custom
          rm -rf dist
          docker system prune -af
          
          echo "Cleanup completed"

  notify:
    name: Notify on Completion
    needs: [build-vm]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check build status
        run: |
          if [ "${{ needs.build-vm.result }}" = "success" ]; then
            echo "✓ All VM builds completed successfully"
            exit 0
          else
            echo "✗ Some builds failed"
            exit 1
          fi
