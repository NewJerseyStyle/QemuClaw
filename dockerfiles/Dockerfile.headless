FROM alpine/openclaw:latest

USER root

# 1. Install system dependencies for VM operation
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
      systemd systemd-sysv \
      grub-pc linux-image-amd64 \
      nginx \
      sudo && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# 2. Set user password and sudo access
RUN echo 'node:openclaw' | chpasswd && \
    usermod -aG sudo node

# 3. Host access: QEMU user-mode networking exposes host at 10.0.2.2.
#    Add hostname alias so services inside the VM (e.g. OpenClaw) can
#    reach host-side LLM APIs (Ollama, LM Studio, etc.) via "host.local".
RUN echo '10.0.2.2 host.local' >> /etc/hosts && \
    echo 'HOST_IP=10.0.2.2' >> /etc/environment

# 4. Configure OpenClaw systemd service
#    Wants (not Requires) mnt-shared.mount so OpenClaw still starts
#    when 9p is unavailable (e.g. Windows host uses SMB instead).
RUN echo "[Unit]\n\
Description=OpenClaw Gateway\n\
After=network.target mnt-shared.mount\n\
Wants=mnt-shared.mount\n\
\n\
[Service]\n\
Type=simple\n\
User=node\n\
WorkingDirectory=/app\n\
ExecStart=/usr/local/bin/node /app/dist/index.js gateway --bind lan\n\
Restart=always\n\
RestartSec=10\n\
\n\
[Install]\n\
WantedBy=multi-user.target" > /etc/systemd/system/openclaw.service

# 5. Configure shared folder auto-mount (9p/virtfs)
RUN mkdir -p /mnt/shared && \
    echo '[Unit]\n\
Description=Mount QEMU shared folder\n\
Before=openclaw.service\n\
\n\
[Mount]\n\
What=host_share\n\
Where=/mnt/shared\n\
Type=9p\n\
Options=trans=virtio,version=9p2000.L,msize=524288\n\
\n\
[Install]\n\
WantedBy=multi-user.target' > /etc/systemd/system/mnt-shared.mount

# 6. Configure Nginx reverse proxy
RUN echo 'server {\n\
    listen 3000;\n\
    server_name _;\n\
    \n\
    location / {\n\
        proxy_pass http://localhost:18789;\n\
        proxy_http_version 1.1;\n\
        proxy_set_header Upgrade $http_upgrade;\n\
        proxy_set_header Connection "upgrade";\n\
        proxy_set_header Host $host;\n\
        proxy_set_header X-Real-IP $remote_addr;\n\
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\
    }\n\
}' > /etc/nginx/sites-available/openclaw 

RUN ln -sf /etc/nginx/sites-available/openclaw /etc/nginx/sites-enabled/ && \
    rm -f /etc/nginx/sites-enabled/default

# 7. Create config directory symlink script
RUN echo '#!/bin/bash\n\
if [ -d "/mnt/shared" ] && [ ! -L "/home/node/.openclaw" ]; then\n\
    mkdir -p /mnt/shared/.openclaw\n\
    ln -sf /mnt/shared/.openclaw /home/node/.openclaw\n\
    chown -h node:node /home/node/.openclaw\n\
fi' > /usr/local/bin/setup-openclaw-config.sh

RUN chmod +x /usr/local/bin/setup-openclaw-config.sh && \
    echo '[Unit]\n\
Description=Setup OpenClaw config symlink\n\
After=mnt-shared.mount\n\
Wants=mnt-shared.mount\n\
\n\
[Service]\n\
Type=oneshot\n\
ExecStart=/usr/local/bin/setup-openclaw-config.sh\n\
RemainAfterExit=yes\n\
\n\
[Install]\n\
WantedBy=multi-user.target' > /etc/systemd/system/setup-openclaw-config.service

# 8. Configure serial console (ttyS0) for QEMU headless operation
RUN systemctl enable serial-getty@ttyS0.service

# 9. Configure GRUB for serial console output
RUN sed -i 's/^GRUB_CMDLINE_LINUX_DEFAULT=.*/GRUB_CMDLINE_LINUX_DEFAULT="quiet"/' /etc/default/grub && \
    sed -i 's/^GRUB_CMDLINE_LINUX=.*/GRUB_CMDLINE_LINUX="console=tty0 console=ttyS0,115200"/' /etc/default/grub && \
    echo 'GRUB_TERMINAL="console serial"' >> /etc/default/grub && \
    echo 'GRUB_SERIAL_COMMAND="serial --speed=115200 --unit=0 --word=8 --parity=no --stop=1"' >> /etc/default/grub

# 10. Enable all services
RUN systemctl enable openclaw.service && \
    systemctl enable nginx.service && \
    systemctl enable mnt-shared.mount && \
    systemctl enable setup-openclaw-config.service && \
    systemctl mask getty@tty1.service

# 11. Network configuration
RUN echo '[Match]\n\
Name=en*\n\
\n\
[Network]\n\
DHCP=yes' > /etc/systemd/network/20-wired.network

RUN systemctl enable systemd-networkd

USER node

CMD ["/sbin/init"]
